# Kubernetes Secrets and HashiCorp Vault

## Kubernetes Secrets and Resource Management

```bash
$ kubectl create secret generic my-secret --from-literal=username='tanmay' --from-literal=password='lucifer'

secret/my-secret created
```

```bash
$ kubectl get secrets

NAME        TYPE     DATA   AGE
my-secret   Opaque   2      57s
```

```bash
$ kubectl describe secret my-secret

Name:         my-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
password:  7 bytes
username:  6 bytes
```

```bash
$ kubectl get secret my-secret -o jsonpath='{.data}'

{"password":"bHVjaWZlcg==","username":"dGFubWF5"}
```

```bash
$ echo bHVjaWZlcg== | base64 --decode

lucifer
```

```bash
$ echo dGFubWF5 | base64 --decode

tanmay
```

## Managing Secrets with Helm

After running gpg --gen-key I added the generated key as an environment variable called GPG_KEY.  

```bash
$ sops -p 7230D482984497492BBDED**************** secrets.yaml
```

```bash
$ helm secrets view secrets.yaml

password: secret1234
```

```bash
$ helm secrets install app-python ./helm-app-python/ -f ./secrets.yaml

NAME: app-python
LAST DEPLOYED: Wed Apr 17 00:49:25 2024
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
     NOTE: It may take a few minutes for the LoadBalancer IP to be available.
           You can watch the status of by running 'kubectl get --namespace default svc -w app-python-helm-app-python'
  export SERVICE_IP=$(kubectl get svc --namespace default app-python-helm-app-python --template "{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}")
  echo http://$SERVICE_IP:5000
removed './secrets.yaml.dec'
```

```bash
$ kubectl get po

NAME                                          READY   STATUS      RESTARTS   AGE
app-python-helm-app-python-7ff9d5869d-vkm6q   1/1     Running     0          54s
```


```bash
$ kubectl exec app-python-helm-app-python-799d4f9866-hd2sc -- printenv | grep MY_PASSWORD

MY_PASSWORD=secret1234
```


```bash
$ kubectl get pods
NAME                                          READY   STATUS      RESTARTS   AGE
app-python-helm-app-python-799d4f9866-hd2sc   1/1     Running     0          11m
preinstall-hook                               0/1     Completed   0          47m
vault-0                                       1/1     Running     0          7m51s
vault-agent-injector-dbfc5cd77-8xzlt          1/1     Running     0          7m51s
```

## Vault Secret Management

### Set a secret in Vault

```
tanmay@tanmay-ubuntu:~/Tanmay/Courses/Devops/S24-core-course-labs/k8s$ kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="myuser" password="my-secret-pass"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2024-04-23T19:05:05.755739335Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2024-04-23T19:05:05.755739335Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    my-secret-pass
username    myuser
/ $ 
```

### Configure Kubernetes Authentication

```
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
> kubernetes_host"https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Failed to parse K=V data: invalid key/value pair "kubernetes_hosthttps://10.96.0.1:443": format must be key=value
/ $ kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
/ $ vault write auth/kubernetes/config \
> kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
>      capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app
/ $ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=internal-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app |
> ^C

/ $ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=internal-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
/ $ exit
```

### Creating Service Accout

```
tanmay@tanmay-ubuntu:~/Tanmay/Courses/Devops/S24-core-course-labs/k8s$ kubectl get sa
NAME                         SECRETS   AGE
default                      0         7d4h
vault                        0         36m
vault-agent-injector         0         36m
tanmay@tanmay-ubuntu:~/Tanmay/Courses/Devops/S24-core-course-labs/k8s$ kubectl create sa internal-app
serviceaccount/internal-app created
tanmay@tanmay-ubuntu:~/Tanmay/Courses/Devops/S24-core-course-labs/k8s$ kubectl get sa
NAME                         SECRETS   AGE
default                      0         7d4h
internal-app                 0         21s
vault                        0         37m
vault-agent-injector         0         37m
tanmay@tanmay-ubuntu:~/Tanmay/Courses/Devops/S24-core-course-labs/k8s$ 
```

### Injecting Vault Secrets

To inject vault secrets, I made the following changes app-python/values.yaml-

```
serviceAccount:
  # Specifies whether a service account should be created
  create: false
  # Automatically mount a ServiceAccount's API credentials?
  automount: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: "internal-app"

podAnnotations: {
  vault.hashicorp.com/agent-inject: 'true'
  vault.hashicorp.com/role: 'internal-app'
  vault.hashicorp.com/agent-inject-secret-database-config.txt: 'internal/data/database/config'
}
podLabels: {}
```

After running the chart, we can verify if the secrets were injected using kubectl exec-

```
anmay@tanmay-ubuntu:~/Tanmay/Courses/Devops/S24-core-course-labs/k8s$ kubectl get po
NAME                                          READY   STATUS      RESTARTS      AGE
app-python-helm-app-python-799d4f9866-hd2sc   1/1     Running     3 (44m ago)   75s
preinstall-hook                               0/1     Completed   0             58m
vault-0                                       1/1     Running     2 (53m ago)   58m
vault-agent-injector-dbfc5cd77-8xzlt          1/1     Running     2 (53m ago)   58m
```

